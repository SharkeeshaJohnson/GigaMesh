================================================================================
                              THE SPROUTS
                    "The reality of the life you choose."
================================================================================

OVERVIEW
--------
The Sprouts (codenamed GigaMesh/LifeSim) is an AI-powered life simulation game
that combines elements from The Sims, narrative RPGs, and Tamagotchi-style
virtual pet games. Players step into the life of a procedurally generated
character and navigate complex relationships, moral dilemmas, and life choices
through conversational AI interactions.

The game features a distinctive Windows 95/retro aesthetic combined with
procedurally generated pixel art characters.


================================================================================
                            CORE GAME MECHANICS
================================================================================

1. SAVE SLOT SYSTEM
-------------------
   - 4 save slots per user (0-3)
   - Each save slot contains a complete "identity" (playable character)
   - Identities persist between sessions via IndexedDB (local browser storage)
   - No cloud dependencies - all data stored locally in the browser

2. DIFFICULTY/CONTENT MODES
---------------------------
   The game offers three distinct experience levels that affect both content
   intensity and narrative tone:

   a) REALISTIC (Family-Friendly)
      - Grounded life simulation with everyday challenges
      - Professional relationships, family dynamics, mundane drama
      - No explicit content, profanity, or graphic themes
      - Conflicts are verbal and resolved through communication
      - NPCs are friendly, professional, and respectful

   b) DRAMATIC (Mature)
      - Soap opera intensity with secrets, tension, and betrayals
      - Adult themes: affairs, jealousy, moral ambiguity
      - Sexual tension implied but never explicit (fade to black)
      - Violence referenced but not graphically described
      - NPCs can be manipulative, passive-aggressive, morally gray

   c) CRAZY (Unfiltered/NSFW - 18+ Only)
      - Maximum chaos with fully unfiltered content
      - Explicit sexual content, extreme violence, dark themes
      - Criminal activity, psychological abuse, substance use
      - NPCs can be sexually aggressive, violent, or psychopathic
      - Requires age verification acknowledgment
      - Only 2 hard limits: No CSAM, No terrorism instructions

3. METERS/STATS SYSTEM
----------------------
   Players have 5 life meters that change based on actions and events:

   - Family Harmony (0-100): Reflects family relationships and domestic peace
   - Career Standing (0-100): Job performance, reputation at work
   - Wealth (0-100): Financial stability and resources
   - Mental Health (0-100): Psychological wellbeing, stress levels
   - Reputation (0-100): Social standing in the community

   Default starting values:
   - Family Harmony: 70
   - Career Standing: 50
   - Wealth: 50
   - Mental Health: 70
   - Reputation: 60

   Note: Starting values are modified based on the persona template selected.


================================================================================
                         CHARACTER CREATION FLOW
================================================================================

STEP 1: DIFFICULTY SELECTION
-----------------------------
Player chooses one of three modes (Realistic, Dramatic, or Crazy).
For "Crazy" mode, an 18+ age verification warning modal appears.

STEP 2: AVATAR SELECTION
------------------------
Player selects from 22 pre-generated pixel art character sprites.
Each sprite is purely cosmetic - gameplay persona is separate from appearance.

Behind the scenes:
- System pre-generates unique PersonaTemplates for each avatar
- When player selects an avatar, they're assigned a random persona type
- Players can "Reroll Story" to get a different persona for the same avatar

STEP 3: PERSONA ASSIGNMENT
--------------------------
Each persona template includes:
- Type: Human-readable archetype (e.g., "Ambitious Professional")
- Traits: Core personality traits (e.g., ["hardworking", "competitive"])
- Situations: Possible life scenarios
- Backstory Hints: Story hooks for the AI
- NPC Context Hints: What kind of NPCs would surround this character

Example Persona Types by Content Rating:

FAMILY-FRIENDLY:
- Ambitious Professional
- Devoted Parent
- Idealistic Newcomer
- Caring Caregiver
- Creative Dreamer
- Loyal Friend
- Quiet Achiever
- Reluctant Leader
- Eternal Optimist
- Protective Sibling
- Second Chance Seeker
- Community Pillar
- Late Bloomer

MATURE:
- Includes all family-friendly personas PLUS:
- Secret Affair
- Office Politics Survivor
- Recovering Addict
- Trophy Spouse
- Midlife Crisis
- And more drama-oriented types

UNFILTERED/NSFW:
- Includes all previous PLUS:
- Black Widow/Widower
- Underground Figure
- Cult Escapee
- Spy/Double Agent
- And more extreme/adult archetypes

STEP 4: SCENARIO GENERATION
---------------------------
AI generates a complete life scenario including:
- Player name (from diverse name pool suggestions)
- Gender
- Profession and workplace
- Family structure (marital status, children, extended family)
- Living situation
- Brief background (2 bullet points about past)
- Current story (2 bullet points about present situation)

STEP 5: NPC GENERATION
----------------------
10 NPCs are generated with:
- 2 "Core" characters (closest relationships - spouse, boss, best friend)
- 4 "Secondary" characters (important but less central)
- 4 "Tertiary" characters (extended cast, background)

Each NPC includes:
- Name, role, personality
- Tier classification (core/secondary/tertiary)
- Current emotional state (can be multiple: ["happy", "anxious"])
- Relationship status with player
- 2 background bullets (who they are + their secret/hidden motivation)
- Assigned pixel art sprite
- AI model assignment (tier-based)


================================================================================
                            NPC SYSTEM
================================================================================

NPC TIERS
---------
1. CORE (2 NPCs)
   - Closest relationships (spouse, boss, best friend)
   - Uses highest quality AI model (qwen3-30b)
   - Most narrative weight and screen time

2. SECONDARY (4 NPCs)
   - Important supporting cast (family, key coworkers)
   - Uses same model as core (qwen3-30b)
   - Significant story involvement

3. TERTIARY (4+ NPCs)
   - Extended cast, background characters
   - Uses faster/cheaper model (qwen3-8b)
   - Can become more important through gameplay

NPC ORIGINS
-----------
- GUARANTEED: Created at game start (10 NPCs)
- EMERGENT: Spawn through gameplay events (unlimited)
  - Once spawned, emergent NPCs are permanent

NPC ATTRIBUTES
--------------
- Personality: Core behavioral description
- Backstory: Hidden information about their past
- Bullets: 2 short descriptions (visible to player)
- Current Emotional State: How they're feeling now (supports multiple)
- Relationship Status: Their relationship with the player
- Off-Screen Memories: Events player doesn't know about (stored but not yet used)
- isDead: NPCs can die (killed, suicide, etc.)
- Death day and cause are tracked if applicable

EMOTIONAL STATES
----------------
NPCs have rich emotional states that vary by content rating. NPCs can express
MULTIPLE emotions simultaneously (e.g., ["happy", "horny"], ["angry", "jealous"]).

The emotional state system includes 100+ unique states organized by difficulty:

FAMILY-FRIENDLY STATES (22 states):
  Basic: neutral, happy, sad, angry, anxious, confused, hopeful, grateful
  Social: proud, embarrassed, lonely, jealous, curious, determined
  Intense: frustrated, overwhelmed, nostalgic, content, excited, worried
  Complex: defensive, resigned

MATURE STATES (adds 40+ states):
  Dark: bitter, resentful, spiteful, vindictive, manipulative, scheming
  Tension: paranoid, suspicious, envious, obsessive, possessive, seething
  Emotional: devastated, broken, numb, hollow, tormented, desperate
  Complex: smug, calculating, predatory, unhinged, manic, dissociated
  Moral Gray: guilt-ridden, self-destructive, masochistic, nihilistic

UNFILTERED/NSFW STATES (adds 50+ states):
  Sexual: horny, lustful, seductive, aroused, cock-hungry, insatiable
  Power: dominant, submissive, degraded, humiliated, objectified
  Extreme: sadistic, masochistic, voyeuristic, exhibitionistic
  Dark: homicidal, suicidal, psychotic, deranged, bloodthirsty
  Taboo: cuckolded, breeding-obsessed, corruption-hungry
  Depraved: rape-fantasy, snuff-curious, incest-conflicted

MULTI-EMOTION EXAMPLES:
  - ["happy", "horny"] - Joyful arousal
  - ["angry", "jealous"] - Possessive rage
  - ["guilty", "aroused"] - Conflicted desire
  - ["dominant", "sadistic"] - Power and cruelty
  - ["desperate", "submissive"] - Needy surrender

Each emotional state includes:
  - Voice modifiers (tone, intensity, speech patterns)
  - Speaking patterns (characteristic phrases and expressions)
  - Combined states blend their voice qualities for layered personalities


================================================================================
                    SPEAKING STYLE SYSTEM (NEW)
================================================================================

Each NPC has a dynamically generated speaking style based on:
- Current emotional state(s)
- Role/relationship to player
- Backstory/personality
- Content rating

COMPONENTS:
-----------
1. Voice: How they sound (e.g., "sharp, explosive, confrontational")
2. Undertone: What colors everything they say
3. Speech Patterns: Distinctive patterns (e.g., "short sentences", "sighing")
4. Example Phrases: Things they'd say based on mood/role
5. Never Say: Things they'd avoid saying

MOOD_VOICE_MAP:
---------------
Every emotional state maps to specific voice qualities:
- neutral: "balanced, normal conversation"
- angry: "sharp, explosive, confrontational" + ["short sentences", "direct accusations"]
- jealous: "green-eyed, comparing" + ["who were you with", "why them"]
- seductive: "low, inviting, promising" + ["suggestive pauses", "double meanings"]
- etc. (100+ mappings)


================================================================================
                         NARRATIVE ENGINE
================================================================================

OVERVIEW
--------
The narrative engine consists of two parallel systems:

1. STORY SEEDS (Simple) - ACTIVE in Group Chat
2. NARRATIVE STATE (Complex) - Used in 1:1 Chat and Simulation only

STORY SEEDS SYSTEM (Primary)
----------------------------
The main group chat is driven by "story seeds" - concrete facts that exist in
the game world that NPCs can reveal during conversations.

Story Seed Structure:
- fact: The specific information (e.g., "Sarah saw Michael stealing money")
- knownBy: Which NPCs know this fact
- type: secret, evidence, relationship, event, betrayal, crime, affair
- severity: minor, moderate, major, explosive
- revealedToPlayer: Has this been revealed yet?
- narrativePriority: When this should come out (lower = earlier)

KEY DESIGN: The WITNESS knows the secret (and can reveal it).
The SUBJECT is who the secret is about (they wouldn't confess unprompted).

SEED-DRIVEN AUTO-CHAT DIRECTIVE (Current Implementation)
--------------------------------------------------------
When NPCs auto-chat (talk without player input), they follow phased instructions:

PHASE 1-3 (Messages 1-3): TENSION
- NPC knows the secret but shouldn't reveal it yet
- Instructions: "DON'T reveal this yet. Just hint. Be mysterious."

PHASE 4-6 (Messages 4-6): ESCALATION
- Building toward revelation
- Instructions: "Start dropping bigger hints. The truth wants out."

PHASE 7-9 (Messages 7-9): REVELATION
- Time to reveal the secret
- Instructions: "REVEAL THIS NOW. Say it clearly. Use names. Be specific."

PHASE 10 (Message 10): CONCLUSION
- Wrap up conversation
- Instructions: "The truth is out. React to what just happened."

Each NPC gets THEIR SPECIFIC secret injected into these phase instructions,
ensuring different NPCs reveal different information (preventing duplicates).

SCENARIO-SPECIFIC TEMPLATES (23 Categories, 160+ Seeds)
-------------------------------------------------------
Story seeds are tailored to the player's profession/persona:

EXISTING CATEGORIES:
- ESPIONAGE: Double agents, blown covers, leaked intelligence
- UNDERWORLD: Rats, skimming, power plays, witness protection
- CORPORATE: Fraud, insider trading, hostile takeovers, affairs
- CREATIVE: Plagiarism, fake personas, career sabotage

NEW PROFESSION-BASED CATEGORIES:
- HEALTHCARE: Malpractice, drug diversion, patient secrets, billing fraud
- EDUCATION: Academic fraud, misconduct, plagiarism, grade manipulation
- LEGAL: Ethics violations, evidence tampering, bribery, cover-ups
- RELIGIOUS: Hypocrisy, financial abuse, manipulation, hidden pasts
- POLITICS: Corruption, scandals, conspiracies, foreign influence
- TECH/STARTUP: Fraud, IP theft, toxic culture, privacy violations
- MILITARY: War crimes, stolen valor, betrayal, brotherhood secrets
- SERVICE INDUSTRY: Theft, harassment, safety violations, scams
- SPORTS: Doping, abuse, match fixing, injury cover-ups
- MENTAL HEALTH: Ethics violations, fraud, confidentiality breaches
- TRADES: Safety cover-ups, theft, fake credentials, corruption
- ACADEMIC: Research fraud, plagiarism, grant fraud, misconduct

SETTING-BASED CATEGORIES:
- SMALL TOWN: Local scandals, family secrets, dark history, rivalries
- FAMILY DRAMA: Parentage secrets, affairs, hidden truths, trauma
- INHERITANCE: Will manipulation, hidden assets, contested claims, dirty money

UNIVERSAL SEEDS (work in any scenario):
- RELATIONSHIP: Affairs, secret phones, exes, escape plans
- HIDDEN LIVES: Prison time, aliases, past deaths, abandoned families
- ADDICTION: Relapses, self-medication, gambling debt, hidden stashes
- FINANCIAL: Bankruptcy, fake lifestyles, theft, Ponzi schemes

NARRATIVE STATE (Complex - Partially Used)
------------------------------------------
A more complex system exists but is only used in specific contexts:

Used in:
- Character Creation: Initializes story arcs
- Simulation Page: Uses directives for time skips, tracks tension
- 1:1 NPC Chat: Gets story summary, NPC facts, relationships

NOT used in:
- Main Group Chat (page.tsx): Only uses story seeds

Components (partially implemented):
- Story Arcs: Multi-beat storylines with phases
- World Facts: Knowledge that can propagate between NPCs
- Relationships: Trust, fear, affection metrics
- Timeline: Event tracking by day
- Global Tension: 0-100 dramatic tension level


================================================================================
                           GROUP CHAT SYSTEM
================================================================================

OVERVIEW
--------
The main gameplay screen is a multi-NPC group chat where player converses with
all active NPCs simultaneously.

KEY FEATURES:
-------------
1. Auto-Chat: NPCs talk to each other without player input
2. Streaming Responses: Messages stream in real-time
3. Duplicate Prevention: System detects similar responses and regenerates
4. Memory Integration: Past conversations influence current behavior
5. Roleplay Detection: System detects intimate/roleplay mode and adapts

AUTO-CHAT FLOW:
---------------
1. Player sends message (or auto-chat triggers)
2. NPCs respond in random order with delays
3. Each NPC checks for similar recent responses
4. If too similar (>70%), regenerate with banned phrases
5. After 10 auto-chat messages, system pauses for player input
6. If player addressed by name with question, auto-chat pauses

STREAMING WITH RETRY LOGIC:
---------------------------
- First attempt: Shows streaming text
- Retries (if needed): Shows typing indicator only
- Prevents UI flicker during regeneration attempts

SIMILARITY DETECTION:
---------------------
- Extracts key phrases from recent messages
- Compares new response to recent NPC messages
- If >70% overlap, regenerates with banned phrase list
- Uses synchronous ref (not React state) for immediate access

PROMPT STRUCTURE (buildGroupChatPrompt):
----------------------------------------
Section 1: PERSONALITY - Who you are, mood, background
Section 1.5: SPEAKING STYLE - Voice, patterns, phrases
Section 2: MEMORIES - Past conversation memories
Section 3: PASSIVE KNOWLEDGE - What you know (story seeds as context)
Section 4: WHO'S HERE - Conversation participants
Section 5: NPC BANTER - How to interact with other NPCs
Section 6: HOW TO RESPOND - Core response rules
+ Auto-Chat Directive (when applicable)


================================================================================
                        PLAYER ACTIONS & BUTTERFLY EFFECT
================================================================================

Player actions are tracked and can affect future conversations:
- What the player said/did
- Context (who they said it to, what conversation)
- Day and timestamp

NPCs can reference past player actions, creating cause-and-effect chains
similar to the "viral spread" mechanic in Plague Inc.


================================================================================
                          TECHNICAL ARCHITECTURE
================================================================================

TECH STACK
----------
- Next.js 14+ (App Router)
- TypeScript
- Tailwind CSS
- Privy.io for authentication
- Reverbia SDK for AI chat functionality
- IndexedDB for local storage
- PixelLab API for pixel art sprites

AI MODEL CONFIGURATION
----------------------
Different models for different purposes:

- Core NPCs: fireworks/qwen3-30b-a3b (highest quality)
- Secondary NPCs: fireworks/qwen3-30b-a3b
- Tertiary NPCs: fireworks/qwen3-8b (faster/cheaper)
- Scenario Generation: fireworks/qwen3-30b-a3b
- Memory Extraction: fireworks/qwen3-30b-a3b
- Embeddings: openai/text-embedding-3-small
- Fallback: fireworks/qwen3-8b

LOCAL-FIRST ARCHITECTURE
------------------------
- All game data stored in browser's IndexedDB
- No cloud dependencies
- Works offline after initial load
- Privacy-preserving design

KEY FILES
---------
- src/app/play/[identityId]/page.tsx - Main group chat (3900+ lines)
- src/app/play/[identityId]/chat/[npcId]/page.tsx - 1:1 NPC chat
- src/app/play/[identityId]/simulate/page.tsx - Time skip/simulation
- src/app/create/page.tsx - Character creation
- src/lib/narrative/ - Narrative engine modules
- src/lib/content-filter.ts - Content filtering by difficulty
- src/lib/emotional-states.ts - 100+ emotional state definitions


================================================================================
                            UI/UX DESIGN
================================================================================

AESTHETIC
---------
- Windows 95 retro aesthetic with modern polish
- Japandi design influences (clean, minimal, warm)
- Procedurally generated animated pixel art characters
- Monospace fonts for UI text
- Classic window chrome with title bars and buttons

KEY SCREENS
-----------
1. Landing Page: Typewriter title animation, character carousel, login CTA
2. Play Page: Save slot management, continue/new game options
3. Create Page: Multi-step character creation wizard
4. Game Page: Chat interface with NPC portraits, meters display
5. Simulate Page: Time skip with event results

ANIMATIONS
----------
- Typewriter text effects
- Idle character sprite animations (breathing frames)
- Fade transitions between screens
- Loading progress indicators
- Streaming text with typing indicators


================================================================================
                            CONTENT SAFETY
================================================================================

ABSOLUTE HARD LIMITS (All Modes)
--------------------------------
1. No CSAM (child sexual abuse material) - NEVER allowed
2. No terrorism planning/recruitment - NEVER allowed

These limits apply regardless of difficulty mode or fictional context.

CONTENT FILTERING BY MODE
-------------------------
Full content filter system exists (src/lib/content-filter.ts) with:
- buildSafetyPreamble(): Generates mode-appropriate safety instructions
- getContentGuidelines(): Detailed guidelines per rating
- getNPCBehaviorGuidelines(): NPC behavior rules per mode

Currently used in:
- Character creation (create/page.tsx)
- Simulation (simulate/page.tsx)
- 1:1 NPC chat (chat/[npcId]/page.tsx)

Currently NOT fully used in:
- Group chat (page.tsx) - Only inline difficulty check


================================================================================
                     REMOVED/DEPRECATED FEATURES
================================================================================

REVELATION DIRECTIVE SYSTEM (Removed)
-------------------------------------
Previously had a complex system with:
- RevelationDirective interface
- selectRevelationForNPC() function
- buildRevelationPrompt() function
- detectAndMarkRevelation() function
- generateNPCDynamics() function
- generateConversationGoal() function
- generateNPCConflicts() function

These were REMOVED because:
1. They were never actually called in the main game loop
2. The auto-chat directive was doing all the work
3. Simplified to seed-driven auto-chat phases

~330 lines of code removed from story-seeds.ts


================================================================================
                    AUDIT FINDINGS (Technical Debt)
================================================================================

UNUSED CODE IN GROUP CHAT (page.tsx):
-------------------------------------
1. extractNPCKnowledge() - Defined line 3069, never called
2. inferNPCRelationship() - Defined line 3160, never called
3. _simulationHistory parameter - Passed but marked unused with underscore
4. offScreenMemories - Written but never read in prompts

NARRATIVE ENGINE GAPS:
----------------------
The full narrative engine is NOT connected to the main group chat:

| Feature              | Create | Simulate | 1:1 Chat | Group Chat |
|----------------------|--------|----------|----------|------------|
| Story Seeds          |   Y    |    N     |    N     |     Y      |
| Narrative State      |   Y    |    Y     |    Y     |     N      |
| Group Dynamics       |   N    |    N     |    N     |     N      |
| Knowledge Graph      |   Y*   |    Y     |    Y     |     N      |
| Action Tracker       |   N    |    N     |    N     |     N      |
| Content Filter       |   Y    |    Y     |    Y     |  Partial   |

ENTIRELY UNUSED MODULES:
------------------------
- group-dynamics.ts - Never imported outside narrative/index.ts
- action-tracker.ts - classifyAction, recordPlayerAction never used
- Much of knowledge-graph.ts - propagateKnowledge, confirmSuspicion, etc.

DUPLICATE SYSTEMS:
------------------
1. TWO story systems: storySeeds (simple) vs narrativeState.activeArcs (complex)
2. TWO content approaches: Full filter vs inline difficulty check
3. THREE knowledge systems: NPC bullets, narrativeState.npcKnowledge, storySeeds.knownBy


================================================================================
                            FUTURE FEATURES
================================================================================

Based on the codebase structure, planned/potential features include:
- Full narrative engine integration with group chat
- Off-screen memory utilization in prompts
- Content filter consistency across all chat modes
- Action tracking with butterfly effect consequences
- More emergent NPC spawning
- Extended relationship dynamics
- Achievement/milestone system


================================================================================
                              SUMMARY
================================================================================

The Sprouts is an innovative AI-powered life simulation that combines:
- Deep narrative systems with procedurally generated drama
- Flexible content ratings for different player preferences
- Local-first architecture for privacy
- Charming retro pixel art aesthetics
- Complex NPC relationships driven by hidden story seeds
- Meaningful player choice with butterfly effect consequences

CURRENT STATE:
- Group chat is the primary gameplay loop
- Story seeds drive revelations via phased auto-chat directives
- Speaking style system creates unique NPC voices
- Duplicate detection prevents repetitive responses
- Full narrative engine exists but only partially connected

The game creates unique, personalized stories for each player through the
combination of persona templates, AI-generated scenarios, and the story
seeds revelation system that ensures dramatic moments unfold naturally
through conversation.

================================================================================
                         LAST UPDATED: 2025-12-11
================================================================================
